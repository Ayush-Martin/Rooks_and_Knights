<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('./partials/head.ejs') %>
        <style>
            /* Custom Wishlist UI Styles (Matched with Cart/Checkout) */
            .checkout-card {
                background: #fff;
                border-radius: 16px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
                padding: 25px;
                margin-bottom: 30px;
                border: 1px solid #f0f0f0;
            }

            .checkout-card-header {
                font-size: 20px;
                font-weight: 700;
                color: #333;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid #f5f5f5;
            }

            .product-list-item {
                display: flex;
                align-items: center;
                padding: 15px 0;
                border-bottom: 1px solid #eee;
                flex-wrap: wrap;
            }

            .product-list-item:last-child {
                border-bottom: none;
            }

            .product-img-wrapper {
                width: 80px;
                height: 80px;
                border-radius: 10px;
                overflow: hidden;
                margin-right: 20px;
                border: 1px solid #eee;
                flex-shrink: 0;
            }

            .product-img-wrapper img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .product-details {
                flex: 1;
                min-width: 200px;
            }

            .product-name {
                font-size: 16px;
                font-weight: 600;
                color: #333;
                text-decoration: none;
                display: block;
                margin-bottom: 5px;
            }

            .product-meta {
                font-size: 14px;
                color: #888;
                margin-bottom: 5px;
            }

            .product-price {
                font-size: 16px;
                font-weight: 700;
                color: #333;
            }

            .product-actions {
                display: flex;
                align-items: center;
                gap: 15px;
                margin-left: 20px;
            }

            .wrap-num-product {
                width: 100px;
                height: 35px;
                border: 1px solid #e6e6e6;
                border-radius: 3px;
                overflow: hidden;
                display: flex;
            }

            .btn-num-product-down,
            .btn-num-product-up {
                width: 30px;
                height: 100%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: #f7f7f7;
                transition: all 0.3s;
            }

            .btn-num-product-down:hover,
            .btn-num-product-up:hover {
                background-color: #717fe0;
                color: #fff;
            }

            .num-product {
                width: calc(100% - 60px);
                height: 100%;
                border-left: 1px solid #e6e6e6;
                border-right: 1px solid #e6e6e6;
                background-color: #f7f7f7;
                text-align: center;
                font-size: 14px;
                color: #666;
            }

            .btn-add-cart {
                background: #333;
                color: #fff;
                border: none;
                border-radius: 5px;
                padding: 8px 15px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
            }

            .btn-add-cart:hover {
                background: #000;
            }

            .btn-delete-item {
                color: #dc3545;
                background: none;
                border: none;
                font-size: 16px;
                cursor: pointer;
                transition: color 0.2s;
                padding: 5px;
            }

            .btn-delete-item:hover {
                color: #a71d2a;
            }

            @media (max-width: 576px) {
                .product-actions {
                    width: 100%;
                    margin-left: 0;
                    margin-top: 10px;
                    justify-content: space-between;
                }
            }
        </style>
</head>

<body class="">
    <header><%- include('./partials/header.ejs') %></header>

    <div class="bg0 p-t-75 p-b-110">
        <% if(wishlist.wishlistItems.length) {%>
            <div class="container">
                <div class="row">
                    <div class="col-lg-10 col-xl-8 m-lr-auto m-b-50">
                        <div class="checkout-card">
                            <div class="checkout-card-header">
                                My Wishlist (<%= wishlist.wishlistItems.length %>)
                            </div>
                            <div class="product-list">
                                <% wishlist.wishlistItems.forEach((wishlistItem)=>{%>
                                    <div class="product-list-item" id="wishlistItemRow_<%= wishlistItem._id %>">
                                        <div class="product-img-wrapper">
                                            <a href="/shop/product/<%= wishlistItem.productID._id %>">
                                                <img src="<%= wishlistItem.productID.productImage1 %>"
                                                    alt="<%= wishlistItem.productID.productName %>">
                                            </a>
                                        </div>
                                        <div class="product-details">
                                            <a href="/shop/product/<%= wishlistItem.productID._id %>"
                                                class="product-name">
                                                <%= wishlistItem.productID.productName %>
                                            </a>
                                            <div class="product-price">
                                                â‚¹<%= Math.round(wishlistItem.productID.price -
                                                    (wishlistItem.productID.price *
                                                    Math.max(wishlistItem.productID.offer,wishlistItem.categoryID.offer,
                                                    wishlistItem.subCategoryID.offer)/100)) %>
                                            </div>
                                            <% if(wishlistItem.productID.stock <=0){%>
                                                <div class="text-danger small mt-1">Out Of Stock</div>
                                                <% } %>
                                        </div>

                                        <div class="product-actions">
                                            <% if(wishlistItem.productID.stock> 0){%>
                                                <form action="/cart/addToCart/<%= wishlistItem.productID._id %>"
                                                    method="post"
                                                    onsubmit="addToCart('<%= wishlistItem.productID._id %>','<%=wishlistItem.productID.categoryID%>','<%=wishlistItem.productID.subCategoryID%>',event)"
                                                    style="display: flex; align-items: center; gap: 10px;">

                                                    <div class="wrap-num-product">
                                                        <div class="btn-num-product-down"
                                                            onclick="decreaseProduct(this)">
                                                            <i class="fs-16 zmdi zmdi-minus"></i>
                                                        </div>
                                                        <input class="num-product" type="number" name="quantity"
                                                            value="1" readonly>
                                                        <div class="btn-num-product-up"
                                                            onclick="increaseProduct(this,'<%= wishlistItem.productID.stock %>')">
                                                            <i class="fs-16 zmdi zmdi-plus"></i>
                                                        </div>
                                                    </div>

                                                    <button type="submit" class="btn-add-cart">
                                                        <i class="fa-solid fa-cart-shopping m-r-5"></i> Add
                                                    </button>
                                                </form>
                                                <% } %>

                                                    <button class="btn-delete-item"
                                                        onclick="deleteWishlistItem('<%=wishlistItem.productID._id%>',event)">
                                                        <i class="fa-solid fa-trash"></i>
                                                    </button>
                                        </div>
                                    </div>
                                    <% }); %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <% }else{ %>
                <div class="m-tb-104 text-center">
                    <p class="fs-31" style="color: rgba(0, 0, 0, 0.351);">Wishlist is Empty</p>
                    <a href="/shop" class="stext-101 cl2 hov-cl1 trans-04 m-tb-10">Continue shopping</a>
                </div>
                <% } %>
    </div>

    <footer class="bg3 p-t-75 p-b-32">
        <%- include('./partials/footer.ejs') %>
    </footer>

    <%- include('./partials/backToTop.ejs') %>
        <%- include('./partials/scriptBody.ejs') %>

            <script>
                const maximumProductQuantity = 10;

                function decreaseProduct(button) {
                    const input = button.parentElement.querySelector('.num-product');
                    const quantityVal = Number(input.value);
                    if (quantityVal > 1) {
                        input.value = quantityVal - 1;
                    };
                }

                function increaseProduct(button, stock) {
                    const input = button.parentElement.querySelector('.num-product');
                    const quantityVal = Number(input.value);

                    if (quantityVal < stock && quantityVal < maximumProductQuantity) {
                        input.value = quantityVal + 1;
                    } else if (quantityVal == maximumProductQuantity) {
                        const Toast = Swal.mixin({
                            toast: true,
                            position: "center-end",
                            showConfirmButton: false,
                            timer: 3000,
                            timerProgressBar: true,
                            didOpen: (toast) => {
                                toast.onmouseenter = Swal.stopTimer;
                                toast.onmouseleave = Swal.resumeTimer;
                            }
                        });
                        Toast.fire({
                            icon: "error",
                            title: `max ${maximumProductQuantity} is allowed`
                        });
                    } else {
                        const Toast = Swal.mixin({
                            toast: true,
                            position: "center-end",
                            showConfirmButton: false,
                            timer: 3000,
                            timerProgressBar: true,
                            didOpen: (toast) => {
                                toast.onmouseenter = Swal.stopTimer;
                                toast.onmouseleave = Swal.resumeTimer;
                            }
                        });
                        Toast.fire({
                            icon: "error",
                            title: "Out of stock"
                        });
                    }
                }

                async function addToCart(productID, categoryID, subCategoryID, event) {
                    event.preventDefault();
                    // Find the quantity input within the submitted form
                    const form = event.target;
                    const quantityInput = form.querySelector('input[name="quantity"]');
                    const quantity = quantityInput ? quantityInput.value : 1;

                    try {
                        const res = await axios.post(`/cart/${productID}`, {
                            quantity, categoryID, subCategoryID
                        })

                        Swal.fire({
                            title: "Good job!",
                            text: "Product added to cart",
                            icon: "success",
                            footer: `<a href="/cart">Go to cart</a>`,
                        })
                    } catch (err) {
                        console.log(err);
                        Swal.fire({
                            icon: "error",
                            title: "Error",
                            text: err.response?.data?.error || "Something went wrong!",
                        });
                    }
                }

                async function deleteWishlistItem(productID, event) {
                    event.preventDefault()
                    const result = await Swal.fire({
                        title: "Are you sure?",
                        text: "You won't be able to revert this!",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#3085d6",
                        cancelButtonColor: "#d33",
                        confirmButtonText: "Yes, delete it!"
                    });

                    if (result.isConfirmed) {
                        try {
                            const res = await axios.delete(`/wishlist/${productID}`);
                            const data = res.data;
                            if (data.success) {
                                Swal.fire({
                                    title: "Deleted!",
                                    text: "Product has been removed from wishlist",
                                    icon: "success",
                                    timer: 2000
                                });
                                setTimeout(() => {
                                    window.location.reload();
                                }, 2000)
                            }
                        } catch (err) {
                            console.log(err);
                            Swal.fire({
                                icon: "error",
                                title: "Error",
                                text: err.response?.data?.error || "Something went wrong!",
                            });
                        }
                    }
                }
            </script>
</body>

</html>