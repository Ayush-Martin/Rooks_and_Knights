<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../partials/head.ejs') %>
    <link rel="stylesheet" href="/public/css/login.css" />
    <style>
      .change-password-container {
        max-width: 500px;
        margin: 50px auto;
        padding: 30px;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      }
      .change-password-title {
        text-align: center;
        margin-bottom: 30px;
        color: #333;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-control {
        height: 45px;
      }
      .btn-submit {
        width: 100%;
        height: 45px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
    </style>
  </head>

  <body>
    <!-- Header -->
    <header class="header-v4"><%- include('../partials/header.ejs') %></header>

    <div class="container">
      <div class="change-password-container">
        <h3 class="change-password-title">Change Password</h3>
        <form id="changePasswordForm" onsubmit="submitChangePassword(event)">
          <div class="form-group">
            <label for="oldPassword">Old Password</label>
            <input
              type="password"
              class="form-control"
              id="oldPassword"
              name="oldPassword"
              required
            />
          </div>
          <div class="form-group">
            <label for="newPassword">New Password</label>
            <input
              type="password"
              class="form-control"
              id="newPassword"
              name="newPassword"
              required
            />
          </div>
          <div class="form-group">
            <label for="confirmPassword">Confirm New Password</label>
            <input
              type="password"
              class="form-control"
              id="confirmPassword"
              name="confirmPassword"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary btn-submit">
            Update Password
          </button>
        </form>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg3 p-t-75 p-b-32">
      <%- include('../partials/footer.ejs') %>
    </footer>

    <%- include('../partials/backToTop.ejs') %> <%-
    include('../partials/scriptBody.ejs') %>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
      function submitChangePassword(event) {
        event.preventDefault();
        const oldPassword = document.getElementById("oldPassword").value;
        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword = document.getElementById("confirmPassword").value;

        if (newPassword !== confirmPassword) {
          Swal.fire({
            icon: "error",
            title: "Validation Error",
            text: "New passwords do not match",
          });
          return;
        }

        if (newPassword.length < 6) {
           Swal.fire({
            icon: "error",
            title: "Validation Error",
            text: "Password must be at least 6 characters long",
          });
          return;
        }

        fetch("/user/account/changePassword", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ oldPassword, newPassword }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              Swal.fire({
                title: "Success",
                text: "Password changed successfully",
                icon: "success",
                timer: 2000,
              });
              setTimeout(() => {
                window.location.href = "/user/account";
              }, 2000);
            } else {
              Swal.fire({
                title: "Error",
                text: data.error || "Failed to change password",
                icon: "error",
              });
            }
          })
          .catch((err) => {
            console.error(err);
            Swal.fire({
              title: "Error",
              text: "Something went wrong",
              icon: "error",
            });
          });
      }
    </script>
  </body>
</html>
