<!DOCTYPE html>
<html lang="en">

<%- include('./partials/header') %>

    <body>
        <div class="wrapper">
            <%- include('./partials/slidebar') %>

                <div id="content" class="container-fluid">
                    <h1 class="m-b-10 admin_title">Users</h1>

                    <div class="container p-b-50">
                        <div class="search-bar-container">
                            <!-- Search Form -->
                            <form action="/admin/users" method="GET" class="search-input-group">
                                <input type="text" id="search-input" name="search" class="form-control search-input"
                                    placeholder="search" value="<%= searchFilter ? searchFilter:null %>">
                                <a href="/admin/users?search=">
                                    <button type="button" class="btn-clear" id="clear-btn">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </a>
                                <button type="submit" class="btn-search">
                                    <i class="fas fa-search"></i>
                                </button>
                            </form>

                        </div>
                    </div>


                    <div class="table-responsive">

                        <table class="table table-bordered m-t-10">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Phone Number</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% userList.forEach(user=> { %>
                                    <tr>
                                        <td>
                                            <%=user.username%>
                                        </td>
                                        <td>
                                            <%=user.email%>
                                        </td>
                                        <td>
                                            <%=user.phoneNumber || 'not given' %>
                                        </td>
                                        <td>
                                            <%if(user.isblocked){ %>
                                                <button class="btn btn-success btn-sm"
                                                    onclick="blockUnblockUser(this,'<%= user._id %>',true)"><i
                                                        class="fa fa-check"></i> Unblock</button>

                                                <% }else{ %>
                                                    <button class="btn btn-dark btn-sm"
                                                        onclick="blockUnblockUser(this,'<%= user._id %>',false)"><i
                                                            class="fa fa-ban"></i> Block</button>
                                                    <%}%>

                                        </td>
                                    </tr>
                                    <%}); %>

                            </tbody>
                        </table>
                    </div>
                    <div class="flex-c-m flex-w w-full p-t-45 gap-10">
                        <!-- Previous Button -->
                        <a href="/admin/users?search=<%= searchFilter %>&&page=<%= (currentPage>1)? Number(currentPage)-1:1 %>"
                            class="m-r-20 text-dark">
                            <i class="fas fa-chevron-left"></i> Previous
                        </a>
                        <P class="m-r-20 text-dark">page : <%= currentPage %> of <%= Math.ceil(totalNoOfPages) %>
                        </P>
                        <!-- Next Button -->
                        <a href="/admin/users?search=<%= searchFilter %>&&page=<%= (currentPage<totalNoOfPages)? Number(currentPage)+1:currentPage %>"
                            class=" text-dark">
                            Next <i class="fas fa-chevron-right"></i>
                        </a>


                    </div>


                </div>


        </div>

        <%- include('./partials/footer') %>

            <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
            <script>

                async function blockUnblockUser(btn, userID, isBlocked) {
                    const action = isBlocked ? 'Unblock' : 'block';
                    const newStatus = !isBlocked;

                    const result = await Swal.fire({
                        title: "Are you sure?",
                        text: `Do you want to ${action} this user?`,
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#3085d6",
                        cancelButtonColor: "#d33",
                        confirmButtonText: "Yes"
                    });

                    if (result.isConfirmed) {
                        try {
                            // Pass isblocked as query parameter as requested
                            const response = await axios.patch(`/admin/users/${userID}?isblocked=${newStatus}`);

                            if (response.status === 200) {
                                const Toast = Swal.mixin({
                                    toast: true,
                                    position: "top-end",
                                    showConfirmButton: false,
                                    timer: 2000,
                                    timerProgressBar: true,
                                    didOpen: (toast) => {
                                        toast.onmouseenter = Swal.stopTimer;
                                        toast.onmouseleave = Swal.resumeTimer;
                                    }
                                });
                                Toast.fire({
                                    icon: "success",
                                    title: `User has been ${action}ed`
                                });

                                // Update button UI without reload
                                if (newStatus) {
                                    // User is now BLOCKED (isblocked=true)
                                    // Button should show "Unblock"
                                    btn.className = 'btn btn-success btn-sm';
                                    btn.innerHTML = '<i class="fa fa-check"></i> Unblock';
                                    btn.setAttribute('onclick', `blockUnblockUser(this, '${userID}', true)`);
                                } else {
                                    // User is now UNBLOCKED (isblocked=false)
                                    // Button should show "Block"
                                    btn.className = 'btn btn-dark btn-sm';
                                    btn.innerHTML = '<i class="fa fa-ban"></i> Block';
                                    btn.setAttribute('onclick', `blockUnblockUser(this, '${userID}', false)`);
                                }
                            }
                        } catch (err) {
                            console.error(err);
                            Swal.fire({
                                icon: "error",
                                title: "Error",
                                text: err.response?.data?.error || "An error occurred"
                            });
                        }
                    }
                }
            </script>
    </body>

</html>