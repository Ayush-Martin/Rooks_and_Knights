<!DOCTYPE html>
<html lang="en">

<%- include('./partials/header') %>
    <style>
        body {
            background-color: #f4f7fa;
            font-family: 'Poppins', sans-serif;
        }

        .content {
            margin-left: 250px;
            background-color: #f4f7fa;
            padding: 20px;
            transition: margin-left 0.3s ease;
        }

        .content.collapsed {
            margin-left: 80px;
        }

        .card {
            border-radius: 8px;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        .card-header {
            background-color: #e9ecef;
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1rem;
            color: #495057;
        }

        .table th,
        .table td {
            vertical-align: middle;
        }
    </style>
    <div class="wrapper">
        <%- include('./partials/slidebar') %>
            <!-- Main Content -->
            <div id="content" class="content">
                <!-- Order Details Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 admin_title">Order Details</h1>
                </div>

                <!-- Order Information -->
                <div class="card">
                    <div class="card-header">
                        Order Information
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <p><strong>Order ID:</strong>
                                    <%= order._id %>
                                </p>
                                <p><strong>Customer Name:</strong>
                                    <%= order.userID.username %>
                                </p>
                                <p><strong>Email:</strong>
                                    <%= order.userID.email %>
                                </p>
                                <p><strong>Order Status:</strong>
                                    <span id="order-status">
                                        <%= order.orderStatus %>
                                    </span>
                                </p>
                                <p><strong>Payment Method:</strong>
                                    <%= order.paymentMethod %>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Order Date:</strong>
                                    <%= order.createdAt.toLocaleDateString(); %>
                                </p>
                                <p><strong>No of Products:</strong>
                                    <%= order.products.length %>
                                </p>
                                <p><strong>Base Price:</strong>
                                    <%= order.basePrice %>
                                </p>
                                <p><strong>Discount:</strong>
                                    <%= order.discount %>
                                </p>
                                <p><strong>Total Amount:</strong>
                                    <%= order.totalAmmount %>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shipping Information -->
                <div class="card">
                    <div class="card-header">
                        Shipping Address
                    </div>
                    <div class="card-body">
                        <p>
                            <%= order.address.addressTitle %> : <%= order.address.state %>, <%= order.address.city %>,
                                        <%= order.address.pinCode %>, <%= order.address.streetAddress %>
                        </p>
                    </div>
                </div>

                <!-- Items Ordered -->
                <div class="card">
                    <div class="card-header">
                        Items Ordered
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Product</th>
                                        <th>Name</th>
                                        <th>Quantity</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% order.products.forEach(product=> {%>
                                        <tr>
                                            <td><img src="<%= product.productID.productImage1 %>" alt="" width="100px">
                                            </td>
                                            <td>
                                                <%= product.productID.productName %>
                                            </td>
                                            <td>
                                                <%= product.quantity %>
                                            </td>
                                            <td>
                                                <%= product.price %>
                                            </td>
                                            <% if(product.status=='pending' ){%>
                                                <td>
                                                    <div class="custom-select-wrapper">
                                                        <select class="custom-select"
                                                            id="product_status_<%= product._id %>">
                                                            <option value="pending" selected>pending</option>
                                                            <option value="delivered">delivered</option>
                                                            <option value="canceled">canceled</option>
                                                        </select>
                                                    </div>
                                                </td>
                                                <td>
                                                    <button class="btn btn-success"
                                                        onclick="updateProductStatus('<%= product._id %>','<%=order._id%>','<%= product.productID._id %>','<%= product.quantity %>')">update</button>
                                                </td>
                                                <% }else{ %>
                                                    <td>
                                                        <%= product.status %>
                                                    </td>
                                                    <td></td>
                                                    <% } %>
                                        </tr>
                                        <% }) %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
    </div>

    <%- include('./partials/footer') %>

        <script>
            async function updateProductStatus(_id, orderID, productID, quantity) {
                const statusSelect = document.getElementById(`product_status_${_id}`);
                const status = statusSelect.value;

                try {
                    const res = await axios.patch(`/admin/orders/${_id}`, {
                        orderID,
                        status,
                        productID,
                        quantity
                    });
                    const data = res.data;

                    if (data.success) {
                        await Swal.fire({
                            title: "Updated",
                            text: "Product status has been updated",
                            icon: "success",
                            timer: 2000,
                            showConfirmButton: false
                        });

                        // Update Order Status
                        const orderStatusElement = document.getElementById('order-status');
                        if (orderStatusElement && data.orderStatus) {
                            orderStatusElement.innerText = data.orderStatus;
                        }

                        // Update Product Row
                        const row = statusSelect.closest('tr');
                        if (status !== 'pending') {
                            // Replace select cell with status text
                            const statusCell = row.cells[4];
                            statusCell.innerText = status;

                            // Clear action cell
                            const actionCell = row.cells[5];
                            actionCell.innerHTML = '';
                        }
                    }
                } catch (err) {
                    console.error(err);
                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: err.response?.data?.error || "Something went wrong!",
                    });
                }
            }
        </script>
        </body>

</html>