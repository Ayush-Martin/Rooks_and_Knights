<!DOCTYPE html>
<html lang="en">

<head>
  <%- include('./partials/head.ejs') %>
</head>

<body class="">
  <!-- Header -->
  <header><%- include('./partials/header.ejs') %></header>

  <div class="wallet-container m-t-100">
    <div class="wallet-amount-section">
      <div class="amount-display">
        <h3><i class="fas fa-wallet"></i> Wallet Balance</h3>
        <p class="amount">
          <%= wallet.balance %>
        </p>
        <button class="add-money-btn" data-toggle="modal" data-target="#exampleModal">
          <i class="fas fa-plus-circle"></i> Add Money
        </button>
      </div>
    </div>
    <div class="transaction-history">
      <h3>Transaction History</h3>
      <table class="transaction-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Amount</th>
            <th>Transition Type</th>
            <th>Payment Method</th>
          </tr>
        </thead>
        <tbody>
          <% transactionList.forEach((transaction)=>{ %>
            <tr>
              <td>
                <%= transaction.createdAt.toLocaleDateString() %>
              </td>
              <td>
                <%= transaction.amount %>
              </td>
              <td>
                <%= transaction.transationType %>
              </td>
              <td>
                <%= transaction.paymentMethod %>
              </td>
            </tr>
            <% }) %>

              <!-- Additional rows can be added here -->
        </tbody>
      </table>
    </div>
  </div>

  <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">
            Add Money To Wallet
          </h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-group">
              <label for="ammount" class="col-form-label">Amount:</label>
              <input type="number" class="form-control" id="amount" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            Close
          </button>
          <button type="button" class="btn btn-primary" onclick="addToWallet()">
            Add Money
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg3 p-t-75 p-b-32">
    <%- include('./partials/footer.ejs') %>
  </footer>

  <%- include('./partials/backToTop.ejs') %> <%- include('./partials/scriptBody.ejs') %>
      <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
      <script>
        async function addToWallet() {
          const amount = document.getElementById("amount").value;

          if (!amount || amount <= 0) {
            Swal.fire({
              icon: "error",
              title: "Invalid Amount",
              text: "Please enter a valid amount greater than 0"
            });
            return;
          }

          try {
            const res = await axios.post("/wallet", {
              amount
            });

            const data = res.data;

            if (data.razorpayOrder) {
              var options = {
                key: "rzp_test_RSspzzgBAA2ViI", // Enter the Key ID generated from the Dashboard
                name: "Rook & Knights",
                description: "Add Money to Wallet",
                image:
                  "https://imgs.search.brave.com/jsPXFiH4YxTvzVbUvQMILb4V32Y6I0DxlC2p3CaqAfA/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9ibG9n/LnBob3RvYWRraW5n/LmNvbS93cC1jb250/ZW50L3VwbG9hZHMv/MjAyMy8wNS8xNjgy/OTQ2NDIzMzgxLTEu/anBn",
                order_id: data.razorpayOrder.id,
                handler: async function (response) {
                  try {
                    const paymentRes = await axios.post("/wallet/completePayment", {
                      razorpay_order_id: response.razorpay_order_id,
                      razorpay_payment_id: response.razorpay_payment_id,
                      razorpay_signature: response.razorpay_signature
                    });

                    if (paymentRes.data.success) {
                      Swal.fire({
                        icon: "success",
                        title: "Success!",
                        text: "Money added to wallet successfully",
                        showConfirmButton: false,
                        timer: 1500
                      }).then(() => {
                        window.location.reload();
                      });
                    }
                  } catch (err) {
                    console.error(err);
                    Swal.fire({
                      icon: "error",
                      title: "Payment Failed",
                      text: err.response?.data?.error || "Payment verification failed"
                    });
                  }
                },
                theme: {
                  color: "#454545",
                },
              };
              var rzp1 = new Razorpay(options);
              rzp1.open();
            }
          } catch (err) {
            console.error(err);
            Swal.fire({
              icon: "error",
              title: "Oops...",
              text: err.response?.data?.error || "Something went wrong!",
              footer: err.response?.data?.errorRedirect
            });
          }
        }
      </script>
</body>

</html>